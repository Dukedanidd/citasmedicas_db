{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 151, "column": 0}, "map": {"version":3,"sources":["file:///home/senorbuen0/ISC/sem6/bd/proyecto/citasmedicas_db/app/api/doctores/%5Bid%5D/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport mysql from 'mysql2/promise';\n\n// Configuración de la base de datos\nconst dbConfig = {\n  host: process.env.DB_HOST || 'localhost',\n  user: process.env.DB_USER || 'root',\n  password: process.env.DB_PASSWORD || '',\n  database: process.env.DB_NAME || 'clinica_db'\n};\n\n// GET /api/doctores/[id] - Obtener un doctor específico\nexport async function GET(\n  request: Request,\n  { params }: { params: { id: string } }\n) {\n  console.log('[GET /api/doctores/[id]] Iniciando petición...');\n  try {\n    const { id } = params;\n    console.log('[GET /api/doctores/[id]] ID del doctor:', id);\n\n    console.log('[GET /api/doctores/[id]] Conectando a la base de datos...');\n    const conn = await mysql.createConnection(dbConfig);\n    console.log('[GET /api/doctores/[id]] Conexión exitosa');\n\n    // Asignar current_user_id para los triggers\n    await conn.execute('SET @current_user_id = 1');\n    console.log('[GET /api/doctores/[id]] current_user_id asignado');\n\n    console.log('[GET /api/doctores/[id]] Ejecutando consulta SQL...');\n    const [rows] = await conn.execute(\n      `SELECT u.user_id AS doctor_id, u.primer_nombre, u.apellido_paterno,\n              u.email, m.especialidad, c.nombre AS consultorio\n       FROM medicos m\n       JOIN usuarios u ON m.doctor_id = u.user_id\n       JOIN consultorios c ON m.consultorio_id = c.consultorio_id\n       WHERE u.user_id = ?`,\n      [id]\n    );\n    console.log('[GET /api/doctores/[id]] Consulta ejecutada. Resultados:', rows);\n\n    await conn.end();\n    console.log('[GET /api/doctores/[id]] Conexión cerrada');\n\n    if (!rows[0]) {\n      return NextResponse.json(\n        { error: 'Doctor no encontrado' },\n        { status: 404 }\n      );\n    }\n\n    return NextResponse.json(rows[0]);\n  } catch (err) {\n    console.error('[GET /api/doctores/[id]] Error:', err);\n    console.error('[GET /api/doctores/[id]] Stack trace:', err.stack);\n    return NextResponse.json(\n      { error: 'Error al obtener el doctor' },\n      { status: 500 }\n    );\n  }\n}\n\n// PUT /api/doctores/[id] - Actualizar un doctor\nexport async function PUT(\n  request: Request,\n  { params }: { params: { id: string } }\n) {\n  console.log('[PUT /api/doctores/[id]] Iniciando petición...');\n  try {\n    const doctor_id = params.id;\n    console.log('[PUT /api/doctores/[id]] ID del doctor:', doctor_id);\n\n    const body = await request.json();\n    console.log('[PUT /api/doctores/[id]] Datos recibidos:', body);\n\n    console.log('[PUT /api/doctores/[id]] Conectando a la base de datos...');\n    const conn = await mysql.createConnection(dbConfig);\n    console.log('[PUT /api/doctores/[id]] Conexión exitosa');\n\n    // Asignar current_user_id para los triggers\n    await conn.execute('SET @current_user_id = 1');\n    console.log('[PUT /api/doctores/[id]] current_user_id asignado');\n\n    // Iniciar transacción\n    console.log('[PUT /api/doctores/[id]] Iniciando transacción...');\n    await conn.beginTransaction();\n\n    try {\n      // Actualizar usuario\n      console.log('[PUT /api/doctores/[id]] Actualizando tabla usuarios...');\n      try {\n        const [userResult] = await conn.execute(\n          `UPDATE usuarios \n           SET primer_nombre = ?, apellido_paterno = ? \n           WHERE user_id = ?`,\n          [body.primer_nombre, body.apellido_paterno, doctor_id]\n        );\n        console.log('[PUT /api/doctores/[id]] Resultado de actualización de usuario:', userResult);\n      } catch (err) {\n        console.error('[PUT /api/doctores/[id]] Error al actualizar usuario:', err);\n        throw err;\n      }\n      console.log('[PUT /api/doctores/[id]] Usuario actualizado');\n\n      // Actualizar médico\n      console.log('[PUT /api/doctores/[id]] Actualizando tabla medicos...');\n      try {\n        const [medicoResult] = await conn.execute(\n          `UPDATE medicos \n           SET especialidad = ?, \n               consultorio_id = NULLIF(?, '')\n           WHERE doctor_id = ?`,\n          [body.especialidad, body.consultorio_id, doctor_id]\n        );\n        console.log('[PUT /api/doctores/[id]] Resultado de actualización de médico:', medicoResult);\n      } catch (err) {\n        console.error('[PUT /api/doctores/[id]] Error al actualizar médico:', err);\n        throw err;\n      }\n      console.log('[PUT /api/doctores/[id]] Médico actualizado');\n\n      // Confirmar transacción\n      console.log('[PUT /api/doctores/[id]] Confirmando transacción...');\n      await conn.commit();\n      console.log('[PUT /api/doctores/[id]] Transacción confirmada');\n\n      await conn.end();\n      console.log('[PUT /api/doctores/[id]] Conexión cerrada');\n\n      return NextResponse.json({ message: 'Doctor actualizado con éxito' });\n    } catch (err) {\n      // Revertir transacción en caso de error\n      console.error('[PUT /api/doctores/[id]] Error en la transacción:', err);\n      await conn.rollback();\n      console.log('[PUT /api/doctores/[id]] Transacción revertida');\n      throw err;\n    }\n  } catch (err) {\n    console.error('[PUT /api/doctores/[id]] Error:', err);\n    console.error('[PUT /api/doctores/[id]] Stack trace:', err.stack);\n    return NextResponse.json(\n      { error: 'Error al actualizar el doctor' },\n      { status: 500 }\n    );\n  }\n}\n\n// DELETE /api/doctores/[id] - Eliminar un doctor\nexport async function DELETE(\n  request: Request,\n  { params }: { params: { id: string } }\n) {\n  console.log('[DELETE /api/doctores/[id]] Iniciando petición...');\n  try {\n    const doctor_id = params.id;\n    console.log('[DELETE /api/doctores/[id]] ID del doctor:', doctor_id);\n\n    console.log('[DELETE /api/doctores/[id]] Conectando a la base de datos...');\n    const conn = await mysql.createConnection(dbConfig);\n    console.log('[DELETE /api/doctores/[id]] Conexión exitosa');\n\n    // Asignar current_user_id para los triggers\n    await conn.execute('SET @current_user_id = 1');\n    console.log('[DELETE /api/doctores/[id]] current_user_id asignado');\n\n    // Primero eliminamos de la tabla medicos\n    console.log('[DELETE /api/doctores/[id]] Eliminando de tabla medicos...');\n    await conn.execute(\n      'DELETE FROM medicos WHERE doctor_id = ?',\n      [doctor_id]\n    );\n    console.log('[DELETE /api/doctores/[id]] Médico eliminado');\n\n    // Luego eliminamos de la tabla usuarios\n    console.log('[DELETE /api/doctores/[id]] Eliminando de tabla usuarios...');\n    await conn.execute(\n      'DELETE FROM usuarios WHERE user_id = ?',\n      [doctor_id]\n    );\n    console.log('[DELETE /api/doctores/[id]] Usuario eliminado');\n\n    await conn.end();\n    console.log('[DELETE /api/doctores/[id]] Conexión cerrada');\n\n    return NextResponse.json({ message: 'Doctor eliminado con éxito' });\n  } catch (err) {\n    console.error('[DELETE /api/doctores/[id]] Error:', err);\n    console.error('[DELETE /api/doctores/[id]] Stack trace:', err.stack);\n    return NextResponse.json(\n      { error: 'Error al eliminar el doctor' },\n      { status: 500 }\n    );\n  }\n} "],"names":[],"mappings":"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"}},
    {"offset": {"line": 322, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}