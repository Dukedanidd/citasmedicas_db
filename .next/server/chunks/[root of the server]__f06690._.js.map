{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 151, "column": 0}, "map": {"version":3,"sources":["file://C%3A/Users/arman/ISC/citasmedicas_db/app/api/doctores/%5Bid%5D/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport mysql from 'mysql2/promise';\r\n\r\n// Configuración de la base de datos\r\nconst dbConfig = {\r\n  host: process.env.DB_HOST || 'localhost',\r\n  user: process.env.DB_USER || 'root',\r\n  password: process.env.DB_PASSWORD || '',\r\n  database: process.env.DB_NAME || 'clinica_db'\r\n};\r\n\r\n// GET /api/doctores/[id] - Obtener un doctor específico\r\nexport async function GET(\r\n  request: Request,\r\n  context: { params: { id: string } }\r\n) {\r\n  console.log('[GET /api/doctores/[id]] Iniciando petición...');\r\n  try {\r\n    const { id } = await context.params;\r\n    console.log('[GET /api/doctores/[id]] ID del doctor:', id);\r\n\r\n    console.log('[GET /api/doctores/[id]] Conectando a la base de datos...');\r\n    const conn = await mysql.createConnection(dbConfig);\r\n    console.log('[GET /api/doctores/[id]] Conexión exitosa');\r\n\r\n    // Asignar current_user_id para los triggers\r\n    await conn.execute('SET @current_user_id = 1');\r\n    console.log('[GET /api/doctores/[id]] current_user_id asignado');\r\n\r\n    console.log('[GET /api/doctores/[id]] Ejecutando consulta SQL...');\r\n    const [rows] = await conn.execute(\r\n      `SELECT u.user_id AS doctor_id, u.primer_nombre, u.segundo_nombre,\r\n              u.apellido_paterno, u.apellido_materno, u.email, \r\n              m.especialidad, c.nombre AS consultorio,\r\n              c.consultorio_id\r\n       FROM medicos m\r\n       JOIN usuarios u ON m.doctor_id = u.user_id\r\n       LEFT JOIN consultorios c ON m.consultorio_id = c.consultorio_id\r\n       WHERE u.user_id = ?`,\r\n      [id]\r\n    );\r\n    console.log('[GET /api/doctores/[id]] Consulta ejecutada. Resultados:', rows);\r\n\r\n    await conn.end();\r\n    console.log('[GET /api/doctores/[id]] Conexión cerrada');\r\n\r\n    if (!rows[0]) {\r\n      return NextResponse.json(\r\n        { error: 'Doctor no encontrado' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json(rows[0]);\r\n  } catch (err) {\r\n    console.error('[GET /api/doctores/[id]] Error:', err);\r\n    console.error('[GET /api/doctores/[id]] Stack trace:', err.stack);\r\n    return NextResponse.json(\r\n      { error: 'Error al obtener el doctor' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// PUT /api/doctores/[id] - Actualizar un doctor\r\nexport async function PUT(\r\n  request: Request,\r\n  context: { params: { id: string } }\r\n) {\r\n  console.log('[PUT /api/doctores/[id]] Iniciando petición...');\r\n  try {\r\n    const { id: doctor_id } = await context.params;\r\n    console.log('[PUT /api/doctores/[id]] ID del doctor:', doctor_id);\r\n\r\n    const body = await request.json();\r\n    console.log('[PUT /api/doctores/[id]] Datos recibidos:', body);\r\n\r\n    // Procesar campos exactamente como lo hace el formulario\r\n    const primer_nombre = body.primer_nombre?.trim() || null;\r\n    const segundo_nombre = body.segundo_nombre || null; // El formulario envía el valor tal cual\r\n    const apellido_paterno = body.apellido_paterno?.trim() || null;\r\n    const apellido_materno = body.apellido_materno || null; // El formulario envía el valor tal cual\r\n    const password = body.password || null; // El formulario envía el valor tal cual\r\n    const especialidad = body.especialidad?.trim() || null;\r\n    const consultorio_id = body.consultorio_id || null;\r\n\r\n    console.log('[PUT /api/doctores/[id]] Valores procesados:', {\r\n      primer_nombre,\r\n      segundo_nombre,\r\n      apellido_paterno,\r\n      apellido_materno,\r\n      password: password ? '[REDACTED]' : null,\r\n      especialidad,\r\n      consultorio_id\r\n    });\r\n\r\n    console.log('[PUT /api/doctores/[id]] Conectando a la base de datos...');\r\n    const conn = await mysql.createConnection(dbConfig);\r\n    console.log('[PUT /api/doctores/[id]] Conexión exitosa');\r\n\r\n    // Asignar current_user_id para los triggers\r\n    await conn.execute('SET @current_user_id = 1');\r\n    console.log('[PUT /api/doctores/[id]] current_user_id asignado');\r\n\r\n    // Iniciar transacción\r\n    console.log('[PUT /api/doctores/[id]] Iniciando transacción...');\r\n    await conn.beginTransaction();\r\n\r\n    try {\r\n      // Verificar que el doctor existe\r\n      const [existingDoctor] = await conn.execute(\r\n        `SELECT u.user_id, m.doctor_id \r\n         FROM usuarios u \r\n         JOIN medicos m ON u.user_id = m.doctor_id \r\n         WHERE u.user_id = ?`,\r\n        [doctor_id]\r\n      );\r\n\r\n      if (!existingDoctor[0]) {\r\n        throw new Error('Doctor no encontrado');\r\n      }\r\n\r\n      // Actualizar usuario\r\n      console.log('[PUT /api/doctores/[id]] Actualizando tabla usuarios...');\r\n      try {\r\n        // Construir la consulta SQL dinámicamente basada en si hay contraseña o no\r\n        let updateUserQuery = `\r\n          UPDATE usuarios \r\n          SET primer_nombre = ?, \r\n              segundo_nombre = ?,\r\n              apellido_paterno = ?,\r\n              apellido_materno = ?\r\n        `;\r\n        \r\n        const updateUserParams = [primer_nombre, segundo_nombre, apellido_paterno, apellido_materno];\r\n\r\n        // Solo actualizar la contraseña si se proporciona una nueva\r\n        if (password) {\r\n          updateUserQuery += `, password = ?`;\r\n          updateUserParams.push(password);\r\n        }\r\n\r\n        updateUserQuery += ` WHERE user_id = ?`;\r\n        updateUserParams.push(doctor_id);\r\n\r\n        const [userResult] = await conn.execute(updateUserQuery, updateUserParams);\r\n        console.log('[PUT /api/doctores/[id]] Resultado de actualización de usuario:', userResult);\r\n      } catch (err) {\r\n        console.error('[PUT /api/doctores/[id]] Error al actualizar usuario:', err);\r\n        throw err;\r\n      }\r\n      console.log('[PUT /api/doctores/[id]] Usuario actualizado');\r\n\r\n      // Actualizar médico\r\n      console.log('[PUT /api/doctores/[id]] Actualizando tabla medicos...');\r\n      try {\r\n        const [medicoResult] = await conn.execute(\r\n          `UPDATE medicos \r\n           SET especialidad = ?, \r\n               consultorio_id = ?\r\n           WHERE doctor_id = ?`,\r\n          [especialidad, consultorio_id, doctor_id]\r\n        );\r\n        console.log('[PUT /api/doctores/[id]] Resultado de actualización de médico:', medicoResult);\r\n      } catch (err) {\r\n        console.error('[PUT /api/doctores/[id]] Error al actualizar médico:', err);\r\n        throw err;\r\n      }\r\n      console.log('[PUT /api/doctores/[id]] Médico actualizado');\r\n\r\n      // Confirmar transacción\r\n      console.log('[PUT /api/doctores/[id]] Confirmando transacción...');\r\n      await conn.commit();\r\n      console.log('[PUT /api/doctores/[id]] Transacción confirmada');\r\n\r\n      // Obtener los datos actualizados del doctor\r\n      console.log('[PUT /api/doctores/[id]] Obteniendo datos actualizados...');\r\n      const [updatedDoctor] = await conn.execute(\r\n        `SELECT u.user_id AS doctor_id, u.primer_nombre, u.segundo_nombre,\r\n                u.apellido_paterno, u.apellido_materno, u.email, \r\n                m.especialidad, c.nombre AS consultorio,\r\n                c.consultorio_id\r\n         FROM medicos m\r\n         JOIN usuarios u ON m.doctor_id = u.user_id\r\n         LEFT JOIN consultorios c ON m.consultorio_id = c.consultorio_id\r\n         WHERE u.user_id = ?`,\r\n        [doctor_id]\r\n      );\r\n      console.log('[PUT /api/doctores/[id]] Datos actualizados obtenidos:', updatedDoctor[0]);\r\n\r\n      // Cerrar la conexión después de obtener los datos\r\n      await conn.end();\r\n      console.log('[PUT /api/doctores/[id]] Conexión cerrada');\r\n\r\n      return NextResponse.json(updatedDoctor[0]);\r\n    } catch (err) {\r\n      // Revertir transacción en caso de error\r\n      console.error('[PUT /api/doctores/[id]] Error en la transacción:', err);\r\n      await conn.rollback();\r\n      console.log('[PUT /api/doctores/[id]] Transacción revertida');\r\n      throw err;\r\n    }\r\n  } catch (err) {\r\n    console.error('[PUT /api/doctores/[id]] Error:', err);\r\n    console.error('[PUT /api/doctores/[id]] Stack trace:', err.stack);\r\n    return NextResponse.json(\r\n      { error: 'Error al actualizar el doctor' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// DELETE /api/doctores/[id] - Eliminar un doctor\r\nexport async function DELETE(\r\n  request: Request,\r\n  context: { params: { id: string } }\r\n) {\r\n  console.log('[DELETE /api/doctores/[id]] Iniciando petición...');\r\n  try {\r\n    const doctor_id = context.params.id;\r\n    console.log('[DELETE /api/doctores/[id]] ID del doctor:', doctor_id);\r\n\r\n    console.log('[DELETE /api/doctores/[id]] Conectando a la base de datos...');\r\n    const conn = await mysql.createConnection(dbConfig);\r\n    console.log('[DELETE /api/doctores/[id]] Conexión exitosa');\r\n\r\n    // Asignar current_user_id para los triggers\r\n    await conn.execute('SET @current_user_id = 1');\r\n    console.log('[DELETE /api/doctores/[id]] current_user_id asignado');\r\n\r\n    // Primero eliminamos de la tabla medicos\r\n    console.log('[DELETE /api/doctores/[id]] Eliminando de tabla medicos...');\r\n    await conn.execute(\r\n      'DELETE FROM medicos WHERE doctor_id = ?',\r\n      [doctor_id]\r\n    );\r\n    console.log('[DELETE /api/doctores/[id]] Médico eliminado');\r\n\r\n    // Luego eliminamos de la tabla usuarios\r\n    console.log('[DELETE /api/doctores/[id]] Eliminando de tabla usuarios...');\r\n    await conn.execute(\r\n      'DELETE FROM usuarios WHERE user_id = ?',\r\n      [doctor_id]\r\n    );\r\n    console.log('[DELETE /api/doctores/[id]] Usuario eliminado');\r\n\r\n    await conn.end();\r\n    console.log('[DELETE /api/doctores/[id]] Conexión cerrada');\r\n\r\n    return NextResponse.json({ message: 'Doctor eliminado con éxito' });\r\n  } catch (err) {\r\n    console.error('[DELETE /api/doctores/[id]] Error:', err);\r\n    console.error('[DELETE /api/doctores/[id]] Stack trace:', err.stack);\r\n    return NextResponse.json(\r\n      { error: 'Error al eliminar el doctor' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n} "],"names":[],"mappings":"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"}},
    {"offset": {"line": 378, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}